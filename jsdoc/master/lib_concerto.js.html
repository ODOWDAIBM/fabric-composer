<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>IBM Concerto Source: lib/concerto.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.spacelab.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">IBM Concerto</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-ibm-concerto.html">ibm-concerto</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="AssetRegistry.html">AssetRegistry</a></li><li><a href="BaseException.html">BaseException</a></li><li><a href="Concerto.html">Concerto</a></li><li><a href="Factory.html">Factory</a></li><li><a href="Identifiable.html">Identifiable</a></li><li><a href="IllegalModelException.html">IllegalModelException</a></li><li><a href="ModelManager.html">ModelManager</a></li><li><a href="ParseException.html">ParseException</a></li><li><a href="Registry.html">Registry</a></li><li><a href="Relationship.html">Relationship</a></li><li><a href="Resource.html">Resource</a></li><li><a href="SecurityContext.html">SecurityContext</a></li><li><a href="SecurityException.html">SecurityException</a></li><li><a href="Serializer.html">Serializer</a></li><li><a href="TransactionRegistry.html">TransactionRegistry</a></li><li><a href="ValidatedResource.html">ValidatedResource</a></li><li><a href="ValidationException.html">ValidationException</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: lib/concerto.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">/*
 * IBM Confidential
 * OCO Source Materials
 * IBM Concerto - Blockchain Solution Framework
 * Copyright IBM Corp. 2016
 * The source code for this program is not published or otherwise
 * divested of its trade secrets, irrespective of what has
 * been deposited with the U.S. Copyright Office.
 */

'use strict';

const AssetRegistry = require('./assetregistry');
const Factory = require('./factory');
const ModelManager = require('./modelmanager');
const ModelRegistry = require('./modelregistry');
const SecurityContext = require('./securitycontext');
const Serializer = require('./serializer');
const TransactionDeclaration = require('./parser/transactiondeclaration');
const TransactionRegistry = require('./transactionregistry');
const Util = require('./util');
const Globalize = require('./globalize');

const hfc = require('hfc');

/**
 * Main entry point into the Concerto solution framework. Use this class
 * to retrieve the services defined by the solution framework and to interact
 * with the underlying Hyperledger fabric. This class is designed to be used in a
 * Node.js based middle-tier of a 3-tier application:
 * &lt;ol>
 *   &lt;li>Presentation tier, e.g. Angular front-end&lt;/li>
 *   &lt;li>Middle tier, exposes domain specific REST APIs to the presentation tier
 *       and embeds the Concerto module to communicate with Hyperledger fabric.&lt;/li>
 *   &lt;li>Hyperledger fabric, used to store assets and transaction on a blockchain&lt;/li>
 * &lt;/ol>
 * &lt;p>
 * The Concerto class provides access to the major subsystems defined by the framework:
 * &lt;ul>
 *   &lt;li>{@link ModelManager} to declare the structure of Resources for an application domain
 *   &lt;li>{@link Factory} to create instances of Resources (Assets, Transactions or Participants)
 *   &lt;li>{@link Serializer} to convert Resources to/from JavaScript Objects for long-term persistence
 *   &lt;li>{@link AssetRegistry} to store Assets on the blockchain
 *   &lt;li>{@link TransactionRegistry} to store Transactions on the blockchain
 *   &lt;li>{@link Concerto#submitTransaction submitTransaction} to submit Transaction for processing to the Hyperledger fabric.
 * &lt;/ul>
 * &lt;/p>
 * &lt;p>
 * The {@link Concerto#connect connect} method is used to connect to a Hyperledger
 * fabric instance.
 * &lt;/p>
 * &lt;p>
 * The {@link Concerto#login login} method is used to authenticate a user/application
 * with the Hyperledger fabric and returns a {@link SecurityContext} that must be
 * passed to other Concerto APIs that require authentication.
 * &lt;/p>
 * &lt;h4>Bootstrapping the Concerto Framework&lt;/h4>
 * &lt;p>
 * The {@link Concerto#deploy deploy} method is used to deploy the Concerto Framework chaincode
 * to your Hyperledger instance. This only needs to be called once for all Concerto
 * based application that use a Hyperledger fabric instance.
 * &lt;/p>
 * &lt;h4>Bootstrapping your Application&lt;/h4>
 * Bootrapping a Concerto-based application requires:
 * &lt;ol>
 *   &lt;li>Connecting to the Hyperledger Fabric using the {@link Concerto.connect connect} method
 *   &lt;li>Login to the Hyperledger Fabric using the {@link Concerto.login login} method
 *   &lt;li>Load the application's domain specific Concerto files and add to the {@link ModelManager}
 *   &lt;li>Use the {@link Concerto#saveModels saveModels} method to store the contents of the {@link ModelManager}
 *       on the blockchain.
 * &lt;/ol>
 * Application bootstrap only needs to be performed once for a given Hyperledger fabric instance,
 * or when the Concerto files have been modified.
 */
class Concerto {

    /**
     * Create an instance of the Concerto class.
     * @param {Object} [options] - an optional set of options to configure the instance.
     * @param {boolean} [options.developmentMode] - specify whether or not the instance
     * is in development mode. Use only for testing purposes!
     */
    constructor(options) {
        this.modelManager = new ModelManager();
        this.factory = new Factory(this.modelManager);
        this.serializer = new Serializer(this.factory, this.modelManager);
        this.chain = null;
        this.developmentMode = false;
        if (options &amp;&amp; options.developmentMode) {
            this.developmentMode = true;
        }
    }

    /**
     * Get a list of all existing asset registries.
     * @param {SecurityContext} securityContext - The user's security context
     * @return {Promise} - A promise that will be resolved with a list of existing
     * asset registries
     */
    getAllAssetRegistries(securityContext) {
        Util.securityCheck(securityContext);
        return AssetRegistry.getAllAssetRegistries(securityContext, this.modelManager, this.factory, this.serializer);
    }

    /**
     * Get an existing asset registry.
     * @param {SecurityContext} securityContext - The user's security context
     * @param {string} id - The unique identifier of the asset registry
     * @return {Promise} - A promise that will be resolved with the existing asset
     * registry, or rejected if the asset registry does not exist.
     */
    getAssetRegistry(securityContext, id) {
        Util.securityCheck(securityContext);
        return AssetRegistry.getAssetRegistry(securityContext, id, this.modelManager, this.factory, this.serializer);
    }

    /**
     * Add a new asset registry.
     * @param {SecurityContext} securityContext - The user's security context
     * @param {string} id - The unique identifier of the asset registry
     * @param {string} name - The name of the asset registry
     * @return {Promise} - A promise that will be resolved with the new asset
     * registry after it has been added.
     */
    addAssetRegistry(securityContext, id, name) {
        Util.securityCheck(securityContext);
        return AssetRegistry.addAssetRegistry(securityContext, id, name, this.modelManager, this.factory, this.serializer);
    }

    /**
     * Get the model registry.
     * @param {SecurityContext} securityContext - The user's security context
     * @return {Promise} - A promise that will be resolved with the model registry.
     * @private
     */
    getModelRegistry(securityContext) {
        Util.securityCheck(securityContext);
        return ModelRegistry
            .getAllModelRegistries(securityContext, this.modelManager)
            .then(function (modelRegistries) {
                if (modelRegistries.length >= 1) {
                    return modelRegistries[0];
                } else {
                    throw new Error('Failed to find the default model registry');
                }
            });
    }

    /**
     * Get the transaction registry.
     * @param {SecurityContext} securityContext - The user's security context
     * @return {Promise} - A promise that will be resolved to the {@link TransactionRegistry}
     */
    getTransactionRegistry(securityContext) {
        Util.securityCheck(securityContext);
        return TransactionRegistry
            .getAllTransactionRegistries(securityContext, this.modelManager, this.factory, this.serializer)
            .then(function (transactionRegistries) {
                if (transactionRegistries.length >= 1) {
                    return transactionRegistries[0];
                } else {
                    throw new Error('Failed to find the default transaction registry');
                }
            });
    }

    /**
     * Returns the Factory, used to create instances of Resources, Relationships
     * and Transactions.
     *
     * @param {SecurityContext} securityContext - The user's security context
     * @return {Factory} the Factory
     */
    getFactory(securityContext) {
        Util.securityCheck(securityContext);
        return this.factory;
    }

    /**
     * Returns the ModelManager, used to define the entities in an application domain.
     * @param {SecurityContext} securityContext - The user's security context
     * @return {ModelManager} the ModelManager
     */
    getModelManager(securityContext) {
        Util.securityCheck(securityContext);
        return this.modelManager;
    }

    /**
     * Returns the Serializer
     * @param {SecurityContext} securityContext - The user's security context
     * @return {Serializer} the Serializer
     */
    getSerializer(securityContext) {
        Util.securityCheck(securityContext);
        return this.serializer;
    }

    /**
     * Connects to the Hyperledger Fabric.
     * @param {Object} connectOptions - The connection options.
     * @param {string} connectOptions.keyValStore - The local directory to store
     * user certificates in.
     * @param {string} connectOptions.membershipServicesURL - The URL of the
     * Hyperledger Fabric membership services to connect to.
     * @param {string} connectOptions.peerURL - The URL of the Hyperledger Fabric
     * peer to connect to.
     * @param {string} connectOptions.eventHubURL - The URL of the Hyperledger Fabric
     * event hub to connect to.
     * @return {Promise} A promise that will be resolved when the connection is
     * established.
     */
    connect(connectOptions) {
        let self = this;
        if (!connectOptions) {
            throw new Error(Globalize.formatMessage('concerto-connect-noconopts'));
        } else if (!connectOptions.keyValStore) {
            throw new Error(Globalize.formatMessage('concerto-connect-nokeyvalstore'));
        } else if (!connectOptions.membershipServicesURL) {
            throw new Error(Globalize.formatMessage('concerto-connect-nomembersrvcurl'));
        } else if (!connectOptions.peerURL) {
            throw new Error(Globalize.formatMessage('concerto-connect-nopeerurl'));
        } else if (!connectOptions.eventHubURL) {
            throw new Error(Globalize.formatMessage('concerto-connect-noeventhuburl'));
        }
        return new Promise(function (resolve, reject) {
            self.chain = hfc.newChain('Concerto');
            self.chain.setKeyValStore(hfc.newFileKeyValStore(connectOptions.keyValStore));
            self.chain.setMemberServicesUrl(connectOptions.membershipServicesURL);
            self.chain.addPeer(connectOptions.peerURL);
            if (connectOptions.deployWaitTime) {
                self.chain.setDeployWaitTime(connectOptions.deployWaitTime);
            }
            if (connectOptions.invokeWaitTime) {
                self.chain.setInvokeWaitTime(connectOptions.invokeWaitTime);
            }
            self.chain.eventHubConnect(connectOptions.eventHubURL);
            process.on('exit', () => {
                if (self.chain) {
                    self.chain.eventHubDisconnect();
                    self.chain = null;
                }
            });
            resolve();
        });
    }

    /**
     * Disconnects from the Hyperledger Fabric.
     * @return {Promise} A promise that will be resolved when the connection is
     * terminated.
     */
    disconnect() {
        let self = this;
        return new Promise(function (resolve, reject) {
            if (self.chain) {
                self.chain.eventHubDisconnect();
                self.chain = null;
            }
            resolve();
        });
    }

    /**
     * Log in to the Hyperledger Fabric as the specified user
     *
     * @param {string} enrollmentID the enrollment ID of the user
     * @param {string} enrollmentSecret the enrollment secret of the user
     * @return {Promise} A promise that will be resolved with a {SecurityContext}
     * when the the security context
     */
    login(enrollmentID, enrollmentSecret) {
        let self = this;
        if (!enrollmentID) {
            throw new Error(Globalize.formatMessage('concerto-login-noenrollmentid'));
        } else if (!enrollmentSecret) {
            throw new Error(Globalize.formatMessage('concerto-login-noenrollmentsecret'));
        }
        return new Promise(function (resolve, reject) {
            self.chain.enroll(enrollmentID, enrollmentSecret, function (error, enrolledMember) {
                if (error) {
                    return reject(error);
                }
                let result = new SecurityContext(enrollmentID, enrollmentSecret);
                result.setEnrolledMember(enrolledMember);
                result.setEventHub(self.chain.getEventHub());
                resolve(result);
            });
        });
    }

    /**
     * Deploys the Concerto chain-code to the Hyperledger Fabric.
     * @param {SecurityContext} securityContext - The user's security context
     * @param {boolean} [force] - Force a new instance of the chain-code to deploy.
     * @return {Promise} A promise that will be fufilled when the chain-code has
     * been deployed.
     */
    deploy(securityContext, force) {
        let self = this;
        if (!securityContext) {
            throw new Error(Globalize.formatMessage('concerto-deploy-nosecuritycontext'));
        }
        return Util
            .deployChainCode(securityContext, 'concerto', 'init', [this.developmentMode.toString()], force)
            .then(function (result) {
                securityContext.setChaincodeID(result.chaincodeID);
            })
            .then(function () {
                return ModelRegistry.getAllModelRegistries(securityContext, self.modelManager);
            })
            .then(function (modelRegistries) {
                if (modelRegistries.length === 0) {
                    return ModelRegistry.addModelRegistry(securityContext, 'default', 'Default Model Registry', self.modelManager);
                }
            })
            .then(function () {
                return TransactionRegistry.getAllTransactionRegistries(securityContext, self.modelManager, self.factory, self.serializer);
            })
            .then(function (transactionRegistries) {
                if (transactionRegistries.length === 0) {
                    return TransactionRegistry.addTransactionRegistry(securityContext, 'default', 'Default Transaction Registry', self.modelManager, self.factory, self.serializer);
                }
            });

    }

    /**
     * Load the models previously saved using {@link Concerto#saveModels saveModels}
     * from the blockchain back into the {@link ModelManager}. Note that any
     * existing models in the ModelManager will be cleared.
     * @param {SecurityContext} securityContext - The user's security context
     * @return {Promise} A promise that will be fufilled when the models have been
     * loaded into the {@link ModelManager}
     */
    loadModels(securityContext) {
        let self = this;
        Util.securityCheck(securityContext);
        return this
            .getModelRegistry(securityContext)
            .then((modelRegistry) => {
                return modelRegistry.getAll(securityContext);
            })
            .then((models) => {
                self.modelManager.clearModelFiles();
                self.modelManager.addModelFiles(models);
            });
    }

    /**
     * Save all of the models in the {@link ModelManager} to the blockchain.
     * @param {SecurityContext} securityContext - The user's security context
     * @return {Promise} A promise that will be fufilled when the models have been
     * saved to the blockchain.
     */
    saveModels(securityContext) {
        let self = this;
        Util.securityCheck(securityContext);
        return this
            .getModelRegistry(securityContext)
            .then((modelRegistry) => {
                let promises = [];
                self.modelManager.getModelFiles().forEach((modelFile) => {
                    promises.push(modelRegistry.add(securityContext, modelFile));
                });
                return Promise.all(promises);
            });
    }

    /**
     * Submit a transaction for processing to the Hyperledger fabric.
     * @param {SecurityContext} securityContext - The user's security context
     * @param {Resource} transaction - The transaction to submit. Use {@link
     * Factory#newTransaction newTransaction} to create this object.
     * @return {Promise} A promise that will be fufilled when the transaction has
     * been processed.
     */
    submitTransaction(securityContext, transaction) {
        Util.securityCheck(securityContext);
        if (!transaction) {
            throw new Error('transaction not specified');
        } else if (!(transaction.getClassDeclaration() instanceof TransactionDeclaration)) {
            throw new Error(transaction.getClassDeclaration().getFullyQualifiedName() + ' is not a transaction');
        }
        let id = transaction.getIdentifier();
        let data = this.serializer.toJSON(transaction);
        return this.getTransactionRegistry(securityContext)
            .then(function (transactionRegistry) {
                return Util.invokeChainCode(securityContext, 'submitTransaction', [transactionRegistry.id, id, JSON.stringify(data)]);
            });
    }

}

module.exports = Concerto;
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


	<span class="copyright">
	Copyright IBM Corp. 2016
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a>
	
		on Fri Oct 21st 2016
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>
